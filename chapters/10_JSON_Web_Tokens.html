
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>JSON Web Tokens (JWT) &#8212; Python Security</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/justify.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script src="../_static/analytics_gtag.js"></script>
    <script src="../_static/analytics.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <link rel="canonical" href="https://elc.github.com/python-security/chapters/10_JSON_Web_Tokens.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="BlockChain - Under Construction" href="19_Blockchain.html" />
    <link rel="prev" title="Common Threats - Under Construction" href="09_Common_Threats.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Python Security</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="00_Fundamentals.html">
                    Introduction to Security
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Hashes
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="01_Hash_Introduction.html">
   Hash Functions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02_Salt.html">
   Salt
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03_Pepper.html">
   Pepper
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="04_Checksum.html">
   Checksum
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="05_HMAC.html">
   HMAC
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Encryption
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="06_Symmetric_Encryption.html">
   Symmetric Encryption
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="07_Asymmetric_Encryption.html">
   Asymmetric Encryption
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Threats
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="08_Input_Sanitization.html">
   Input Sanitization - Under Construction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="09_Common_Threats.html">
   Common Threats - Under Construction
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Applications
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   JSON Web Tokens (JWT)
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="19_Blockchain.html">
   BlockChain - Under Construction
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Additional Material
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="80_Additional_Resources.html">
   Additional Resources
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Appendices
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="91_Bytes.html">
   Bytes Data Type
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="92_Base64.html">
   Base64 Encoding
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/ELC/python-security/source?urlpath=tree/chapters/10_JSON_Web_Tokens.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
      <li>
        <a href="https://colab.research.google.com/github/ELC/python-security/blob/source/chapters/10_JSON_Web_Tokens.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Colab"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../_static/images/logo_colab.png">
  </span>
<span class="headerbtn__text-container">Colab</span>
</a>

      </li>
      
      <li>
        
<button onclick="initThebeSBT()"
  class="headerbtn headerbtn-launch-thebe"
  data-toggle="tooltip"
data-placement="left"
title="Launch Thebe"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="headerbtn__text-container">Live Code</span>
</button>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/ELC/python-security"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/ELC/python-security/edit/source/chapters/10_JSON_Web_Tokens.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Edit this page"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="headerbtn__text-container">suggest edit</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/chapters/10_JSON_Web_Tokens.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#hmac-implementation-using-native-python">
   HMAC Implementation using Native Python
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data">
     Data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#headers">
     Headers
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#payload">
     Payload
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#signature">
     Signature
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#token">
     Token
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#verify">
     Verify
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#changing-headers">
     Changing Headers
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#changing-payload">
     Changing Payload
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#changing-signature">
     Changing Signature
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#changing-two-parts">
     Changing Two Parts
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#using-original-token-parts">
     Using Original Token Parts
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#hmac-implementation-using-a-library">
   HMAC Implementation using a Library
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#supported-algorithms">
     Supported Algorithms
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     Data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#generating-token">
     Generating Token
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#verifing-token">
     Verifing Token
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#trying-to-tamper-the-token">
       Trying to tamper the token
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id2">
       Using Original Token Parts
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#using-rsa">
   Using RSA
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#common-data">
     Common Data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#using-cryptography-alone">
     Using Cryptography alone
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id3">
       Signature
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#encoding-headers-and-payload">
         Encoding Headers and Payload
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#signing">
         Signing
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id4">
       Token
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#verify-token">
       Verify Token
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#tampering-scenarios">
         Tampering Scenarios
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#using-python-jose">
     Using Python JOSE
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#generating-the-token">
       Generating the Token
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#verify-the-token">
       Verify the Token
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#id5">
         Tampering Scenarios
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#native-vs-library">
   Native vs Library
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#cross-compatibility">
     Cross Compatibility
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#using-hmac">
     Using HMAC
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#encode-with-native-decode-with-library">
       Encode with Native decode with Library
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#encode-with-library-decode-with-native">
       Encode with Library decode with Native
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id6">
     Using RSA
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#encode-with-cryptography-decode-with-python-jose">
       Encode with Cryptography decode with Python JOSE
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#encode-with-python-jose-decode-with-cryptography">
       Encode with Python JOSE decode with Cryptography
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#hmac-time-benchmark">
     HMAC Time Benchmark
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id7">
       Generating the token
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#verifying-the-token">
       Verifying the token
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#rsa-time-benchmark">
     RSA Time Benchmark
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id8">
       Generating the token
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id9">
       Verifying the token
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#caveats-other-jwt-features">
     Caveats: Other JWT Features
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#not-valid-before-date">
       Not Valid Before Date
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#expiration-date">
     Expiration Date
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#comparison-conclusion">
     Comparison Conclusion
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#example-user-authentication">
   Example: User Authentication
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#auxiliary-functions">
     Auxiliary Functions
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#sign-up">
     Sign Up
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#log-in">
     Log In
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#not-enough-priviliges">
       Not Enough Priviliges
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tampering-priviliges">
       Tampering Priviliges
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#having-enough-priviliges">
       Having Enough Priviliges
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#token-expired">
       Token Expired
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#caveats">
       Caveats
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#conclusion">
   Conclusion
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#additional-resources">
   Additional Resources
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>JSON Web Tokens (JWT)</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#hmac-implementation-using-native-python">
   HMAC Implementation using Native Python
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#data">
     Data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#headers">
     Headers
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#payload">
     Payload
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#signature">
     Signature
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#token">
     Token
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#verify">
     Verify
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#changing-headers">
     Changing Headers
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#changing-payload">
     Changing Payload
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#changing-signature">
     Changing Signature
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#changing-two-parts">
     Changing Two Parts
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#using-original-token-parts">
     Using Original Token Parts
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#hmac-implementation-using-a-library">
   HMAC Implementation using a Library
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#supported-algorithms">
     Supported Algorithms
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id1">
     Data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#generating-token">
     Generating Token
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#verifing-token">
     Verifing Token
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#trying-to-tamper-the-token">
       Trying to tamper the token
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id2">
       Using Original Token Parts
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#using-rsa">
   Using RSA
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#common-data">
     Common Data
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#using-cryptography-alone">
     Using Cryptography alone
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id3">
       Signature
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#encoding-headers-and-payload">
         Encoding Headers and Payload
        </a>
       </li>
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#signing">
         Signing
        </a>
       </li>
      </ul>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id4">
       Token
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#verify-token">
       Verify Token
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#tampering-scenarios">
         Tampering Scenarios
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#using-python-jose">
     Using Python JOSE
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#generating-the-token">
       Generating the Token
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#verify-the-token">
       Verify the Token
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h5 nav-item toc-entry">
        <a class="reference internal nav-link" href="#id5">
         Tampering Scenarios
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#native-vs-library">
   Native vs Library
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#cross-compatibility">
     Cross Compatibility
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#using-hmac">
     Using HMAC
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#encode-with-native-decode-with-library">
       Encode with Native decode with Library
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#encode-with-library-decode-with-native">
       Encode with Library decode with Native
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#id6">
     Using RSA
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#encode-with-cryptography-decode-with-python-jose">
       Encode with Cryptography decode with Python JOSE
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#encode-with-python-jose-decode-with-cryptography">
       Encode with Python JOSE decode with Cryptography
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#hmac-time-benchmark">
     HMAC Time Benchmark
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id7">
       Generating the token
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#verifying-the-token">
       Verifying the token
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#rsa-time-benchmark">
     RSA Time Benchmark
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id8">
       Generating the token
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id9">
       Verifying the token
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#caveats-other-jwt-features">
     Caveats: Other JWT Features
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#not-valid-before-date">
       Not Valid Before Date
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#expiration-date">
     Expiration Date
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#comparison-conclusion">
     Comparison Conclusion
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#example-user-authentication">
   Example: User Authentication
  </a>
  <ul class="nav section-nav flex-column">
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#auxiliary-functions">
     Auxiliary Functions
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#sign-up">
     Sign Up
    </a>
   </li>
   <li class="toc-h3 nav-item toc-entry">
    <a class="reference internal nav-link" href="#log-in">
     Log In
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#not-enough-priviliges">
       Not Enough Priviliges
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#tampering-priviliges">
       Tampering Priviliges
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#having-enough-priviliges">
       Having Enough Priviliges
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#token-expired">
       Token Expired
      </a>
     </li>
     <li class="toc-h4 nav-item toc-entry">
      <a class="reference internal nav-link" href="#caveats">
       Caveats
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#conclusion">
   Conclusion
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#additional-resources">
   Additional Resources
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="json-web-tokens-jwt">
<h1>JSON Web Tokens (JWT)<a class="headerlink" href="#json-web-tokens-jwt" title="Permalink to this headline">#</a></h1>
<p><strong>ToDo</strong>:</p>
<ul class="simple">
<li><p>Add diagram about how JWT is used - Similar to <a class="reference external" href="https://eldevsin.site/content/images/2020/05/JWT_flow.png">this</a></p></li>
<li><p>Add relevant resources at the end</p></li>
</ul>
<hr class="docutils" />
<p><a class="reference external" href="https://en.wikipedia.org/wiki/JSON_Web_Token">JSON Web Tokens (JWT)</a> is a concrete implementation of many concepts covered so far. It is basically a sequence of bytes (i.e. a token) which contains three parts:</p>
<ol class="simple">
<li><p>Header: Contains standard fields such as the algorithm (<code class="docutils literal notranslate"><span class="pre">alg</span></code>) to be used and the token type (<code class="docutils literal notranslate"><span class="pre">typ</span></code>).</p></li>
<li><p>Payload: <a class="reference external" href="https://en.wikipedia.org/wiki/Payload_(computing)">Payload</a> is a name used in communications to refer to the “actual message”, anything that is not control, header, redundancy, the actual data being transmitted. There are standards fields such as the timestamp (<code class="docutils literal notranslate"><span class="pre">iat</span></code>), unique ID (<code class="docutils literal notranslate"><span class="pre">jti</span></code>) or expiration time (<code class="docutils literal notranslate"><span class="pre">exp</span></code>). However custom fields could be added as well.</p></li>
<li><p>Signature: the digital signature signed by the party generating the JWT (usually a server), it is base64 encoded and could either use HMAC or RSA, as specified in the <code class="docutils literal notranslate"><span class="pre">alg</span></code> header.</p></li>
</ol>
<p>There are <a class="reference external" href="https://en.wikipedia.org/wiki/JSON_Web_Token?oldformat=true#Standard_fields">standard fields</a> both for the header and the payload but new user-defined fields can be added to the payload. Since the data in the payload is not necessarily true (i.e. one has to verify the signature first) the payload fields are usually refered to as “claims”. This is consistent with the concept of <a class="reference external" href="https://en.wikipedia.org/wiki/Claims-based_identity">Claims-based identity</a>.</p>
<p>When dealing with a single server, it might not be as useful because the party reading the claims will be the one who generated it. However, on microservices or multi service architecture, it would be possible to have claims generated by one service being verified by another service. For instance, if you logged in as Admin in the ERP module, you would also have admin access in the CRM module. Another example could be: a user logged as admin in the Client Module is not granted admin access to the Audit Module. This way services can all speak the same language (JWT), and verify the identity of the user and avoiding redundant look ups to databases, repetitive log ins or several implementations of security layers in different services.</p>
<p>To generate the token, the three parts are base64urlsafe (see <a class="reference internal" href="92_Base64.html"><span class="doc std std-doc">Base64 Appendix</span></a>) encoded can concatenate together using <code class="docutils literal notranslate"><span class="pre">.</span></code> as separators.</p>
<p>An example of a JWT:</p>
<p><code class="docutils literal notranslate"><span class="pre">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.SflKxwRJSMeKKF2QT4fwpMeJf36POk6yJV_adQssw5c</span></code></p>
<p>The <code class="docutils literal notranslate"><span class="pre">Header</span></code> and the <code class="docutils literal notranslate"><span class="pre">Payload</span></code> are both <code class="docutils literal notranslate"><span class="pre">unencrypted</span></code> and simply encoded in base64. The <code class="docutils literal notranslate"><span class="pre">Signature</span></code> (either HMAC based or RSA based), once computed, is also base64 encoded and concatenated with the other two encoded parts.</p>
<p>This gives JWTs the following features:</p>
<ul class="simple">
<li><p>It supports symmetric and asymmetric signatures (via HMAC and RSA respectively).</p></li>
<li><p>It allows a user to have all the system related information centralized in one token.</p></li>
<li><p>It provides a standarized way to authenticate and communicate between applications.</p></li>
</ul>
<section id="hmac-implementation-using-native-python">
<h2>HMAC Implementation using Native Python<a class="headerlink" href="#hmac-implementation-using-native-python" title="Permalink to this headline">#</a></h2>
<p>There are libraries to work with JWT, however implementing everything from scratch allows for a better understanding of each component, specially when re-using familiar concepts. Only using the stadndard library is enough to generate HMACs JWTs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import secrets
import base64
import json
import hmac
import hashlib
</pre></div>
</div>
</div>
</div>
<section id="data">
<h3>Data<a class="headerlink" href="#data" title="Permalink to this headline">#</a></h3>
<p>Each JWT will have a header and a payload, in case of the HMAC based, a secret is also required.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>headers = {
  &quot;alg&quot;: &quot;HS256&quot;,
  &quot;typ&quot;: &quot;JWT&quot;
}

payload = {
  &quot;sub&quot;: &quot;1234567890&quot;,
  &quot;name&quot;: &quot;John Doe&quot;,
  &quot;iat&quot;: 1516239022
}

secret = secrets.token_bytes(16)
</pre></div>
</div>
</div>
</div>
</section>
<section id="headers">
<h3>Headers<a class="headerlink" href="#headers" title="Permalink to this headline">#</a></h3>
<p>Each of the parts should be encoded using base64 urlsafe</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>header_bytes = json.dumps(headers).encode(&quot;utf-8&quot;)
encoded_header = base64.urlsafe_b64encode(header_bytes).decode(&quot;utf-8&quot;)

print(f&quot;Original Headers: {headers}&quot;)
print(f&quot; Encoded Headers: {encoded_header}&quot;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Original Headers: {&#39;alg&#39;: &#39;HS256&#39;, &#39;typ&#39;: &#39;JWT&#39;}
 Encoded Headers: eyJhbGciOiAiSFMyNTYiLCAidHlwIjogIkpXVCJ9
</pre></div>
</div>
</div>
</div>
</section>
<section id="payload">
<h3>Payload<a class="headerlink" href="#payload" title="Permalink to this headline">#</a></h3>
<p>Each of the parts should be encoded using base64 urlsafe</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>payload_bytes = json.dumps(payload).encode(&quot;utf-8&quot;)
encoded_payload = base64.urlsafe_b64encode(payload_bytes).decode(&quot;utf-8&quot;)

print(f&quot;Original Payload: {payload}&quot;)
print(f&quot; Encoded Payload: {encoded_payload}&quot;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Original Payload: {&#39;sub&#39;: &#39;1234567890&#39;, &#39;name&#39;: &#39;John Doe&#39;, &#39;iat&#39;: 1516239022}
 Encoded Payload: eyJzdWIiOiAiMTIzNDU2Nzg5MCIsICJuYW1lIjogIkpvaG4gRG9lIiwgImlhdCI6IDE1MTYyMzkwMjJ9
</pre></div>
</div>
</div>
</div>
</section>
<section id="signature">
<h3>Signature<a class="headerlink" href="#signature" title="Permalink to this headline">#</a></h3>
<p>Instead of passing the header and the payload object, the standard defines that the signature should be done on the encoded version of those parts. That means that the third part is a signature for the first two strings in the JWT.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>message = (encoded_header + &quot;.&quot; +  encoded_payload).encode(&quot;utf-8&quot;)
signature_bytes = hmac.digest(secret, message, digest=hashlib.sha256)

encoded_signature = base64.urlsafe_b64encode(signature_bytes).decode(&quot;utf-8&quot;)

print(f&quot;Original Signature: {signature_bytes.hex()}&quot;)
print(f&quot; Encoded Signature: {encoded_signature}&quot;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Original Signature: 5ef52c3eb14dac3ea5fb6b0871bcbfc1b47fc5b65ad6ae639eb88557ba7463d7
 Encoded Signature: XvUsPrFNrD6l-2sIcby_wbR_xbZa1q5jnriFV7p0Y9c=
</pre></div>
</div>
</div>
</div>
</section>
<section id="token">
<h3>Token<a class="headerlink" href="#token" title="Permalink to this headline">#</a></h3>
<p>Once all components are ready, building the token is simply concanetating the parts with <code class="docutils literal notranslate"><span class="pre">.</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>token = f&quot;{encoded_header}.{encoded_payload}.{encoded_signature}&quot; 
print(f&quot;JWT: {token}&quot;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>JWT: eyJhbGciOiAiSFMyNTYiLCAidHlwIjogIkpXVCJ9.eyJzdWIiOiAiMTIzNDU2Nzg5MCIsICJuYW1lIjogIkpvaG4gRG9lIiwgImlhdCI6IDE1MTYyMzkwMjJ9.XvUsPrFNrD6l-2sIcby_wbR_xbZa1q5jnriFV7p0Y9c=
</pre></div>
</div>
</div>
</div>
</section>
<section id="verify">
<h3>Verify<a class="headerlink" href="#verify" title="Permalink to this headline">#</a></h3>
<p>Once the token is ready, it is crucial to have a way to verify the signature.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def verify(token, secret):
    encoded_header, encoded_payload, encoded_signature = token.split(&quot;.&quot;)
    message = (encoded_header + &quot;.&quot; + encoded_payload).encode(&quot;utf-8&quot;)
    
    computed_signature = hmac.digest(secret, message, digest=hashlib.sha256)
    
    padding_correction = &quot;=&quot; * ((4 - len(encoded_signature) % 4) % 4)
    received_signature = base64.urlsafe_b64decode(encoded_signature + padding_correction)

    if hmac.compare_digest(computed_signature, received_signature):
        return &quot;The token is Valid&quot;
    return &quot;The token is NOT Valid&quot;
</pre></div>
</div>
</div>
</div>
</section>
<section id="changing-headers">
<h3>Changing Headers<a class="headerlink" href="#changing-headers" title="Permalink to this headline">#</a></h3>
<p>If any of the headers are changed, or a new header is added, the verification will fail.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>tampered_headers = {
  &quot;alg&quot;: &quot;HS256&quot;,
  &quot;typ&quot;: &quot;JWT&quot;,
  &quot;extra&quot;: 1
}

tampered_headers_bytes = json.dumps(tampered_headers).encode(&quot;utf-8&quot;)
encoded_tampered_header = base64.urlsafe_b64encode(tampered_headers_bytes).decode(&quot;utf-8&quot;)

_, encoded_payload, encoded_signature = token.split(&quot;.&quot;)
tampered_token = f&quot;{encoded_tampered_header}.{encoded_payload}.{encoded_signature}&quot; 

verification = verify(tampered_token, secret)
print(verification)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The token is NOT Valid
</pre></div>
</div>
</div>
</div>
</section>
<section id="changing-payload">
<h3>Changing Payload<a class="headerlink" href="#changing-payload" title="Permalink to this headline">#</a></h3>
<p>The same applies to the payload, this is consistent with what was shown in the <a class="reference internal" href="07_Asymmetric_Encryption.html"><span class="doc std std-doc">Asymmetric Chapter</span></a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>tampered_payload = {
  &quot;sub&quot;: &quot;1234567890&quot;,
  &quot;name&quot;: &quot;Alice&quot;,
  &quot;iat&quot;: 1516239022
}

tampered_payload_bytes = json.dumps(tampered_payload).encode(&quot;utf-8&quot;)
encoded_tampered_payload = base64.urlsafe_b64encode(tampered_payload_bytes).decode(&quot;utf-8&quot;)

encoded_header, _, encoded_signature = token.split(&quot;.&quot;)
tampered_token = f&quot;{encoded_header}.{encoded_tampered_payload}.{encoded_signature}&quot; 

verification = verify(tampered_token, secret)
print(verification)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The token is NOT Valid
</pre></div>
</div>
</div>
</div>
</section>
<section id="changing-signature">
<h3>Changing Signature<a class="headerlink" href="#changing-signature" title="Permalink to this headline">#</a></h3>
<p>As seen in the <a class="reference internal" href="05_HMAC.html"><span class="doc std std-doc">HMAC chapter</span></a> the only way to generate a valid signature that will be verifiable by two parties is when both have the same secret. Generating a new signature with a different secret will not work and the token will no be valid.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>guess_secret = b&quot;admin&quot;

encoded_header, encoded_payload, _ = token.split(&quot;.&quot;)
message = (encoded_header + &quot;.&quot; +  encoded_payload).encode(&quot;utf-8&quot;)

signature_bytes = hmac.digest(guess_secret, message, digest=hashlib.sha256)
encoded_tampered_signature = base64.urlsafe_b64encode(signature_bytes).decode(&quot;utf-8&quot;)

tampered_token = f&quot;{encoded_header}.{encoded_payload}.{encoded_tampered_signature}&quot; 

verification = verify(tampered_token, secret)
print(verification)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The token is NOT Valid
</pre></div>
</div>
</div>
</div>
</section>
<section id="changing-two-parts">
<h3>Changing Two Parts<a class="headerlink" href="#changing-two-parts" title="Permalink to this headline">#</a></h3>
<p>Changing a single part is enough for the token to be invalid, having changed two or more would have thrown the same errors.</p>
<p>The secret the verfier will use to verify the token is extremely likely (yet not impossible) to differ from the one a potential attacker might use. The only possibility to alter the JWT is by having the correct secret beforehand.</p>
</section>
<section id="using-original-token-parts">
<h3>Using Original Token Parts<a class="headerlink" href="#using-original-token-parts" title="Permalink to this headline">#</a></h3>
<p>When the original header, payload and signature are intact, the signature is verified and the token can be trusted.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>verification = verify(token, secret)
print(verification)

_, encoded_payload, _ = token.split(&quot;.&quot;)
decoded_payload = base64.urlsafe_b64decode(encoded_payload)
decoded_payload = json.loads(decoded_payload)

print(f&quot;Decoded Payload: {decoded_payload}&quot;)
print(f&quot;   Payload Type: {type(decoded_payload)}&quot;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The token is Valid
Decoded Payload: {&#39;sub&#39;: &#39;1234567890&#39;, &#39;name&#39;: &#39;John Doe&#39;, &#39;iat&#39;: 1516239022}
   Payload Type: &lt;class &#39;dict&#39;&gt;
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="hmac-implementation-using-a-library">
<h2>HMAC Implementation using a Library<a class="headerlink" href="#hmac-implementation-using-a-library" title="Permalink to this headline">#</a></h2>
<p>The <a class="reference external" href="https://github.com/mpdavis/python-jose">Python JOSE</a> library has support for many JWT algorithms, including HMAC and RSA versions. It also handle many edge cases that would be otherwise complicated to handle with a from scratch implementation.</p>
<p>It is possible to use it with different backends:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/pyca/cryptography">PyCA Cryptography</a></p></li>
<li><p><a class="reference external" href="https://github.com/Legrandin/pycryptodome">PyCryptodome</a></p></li>
<li><p>Native (uses <a class="reference external" href="https://github.com/sybrenstuvel/python-rsa">Python RSA</a> and <a class="reference external" href="https://github.com/tlsfuzzer/python-ecdsa">Python ECDSA</a>)</p></li>
</ul>
<p>The Cryptography library was the one used for the Symmetric and Asymmetric chapters and is the most popular one, therefore it will be the one used in this chapter.</p>
<p>To install Python JOSE simply run</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">python</span><span class="o">-</span><span class="n">jose</span><span class="p">[</span><span class="n">cryptography</span><span class="p">]</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from jose import jwt
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">ModuleNotFoundError</span><span class="g g-Whitespace">                       </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">12</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="kn">from</span> <span class="nn">jose</span> <span class="kn">import</span> <span class="n">jwt</span>

<span class="ne">ModuleNotFoundError</span>: No module named &#39;jose&#39;
</pre></div>
</div>
</div>
</div>
<section id="supported-algorithms">
<h3>Supported Algorithms<a class="headerlink" href="#supported-algorithms" title="Permalink to this headline">#</a></h3>
<p>This is the list of all supported algorithms in Python JOSE</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>&quot;, &quot;.join(jwt.ALGORITHMS.SUPPORTED)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;RSA1_5, A256KW, HS256, A192CBC-HS384, ES256, RSA-OAEP-256, A256GCM, HS384, A128GCM, HS512, A256CBC-HS512, ES512, dir, A192GCM, A128CBC-HS256, A128KW, ES384, A192KW, RS256, RSA-OAEP, RS384, RS512&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="id1">
<h3>Data<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<p>The same data is used as in the native implementation.</p>
</section>
<section id="generating-token">
<h3>Generating Token<a class="headerlink" href="#generating-token" title="Permalink to this headline">#</a></h3>
<p>Python JOSE exposes a function <code class="docutils literal notranslate"><span class="pre">encode</span></code> that base64 encodes the headers, the payload and generated an appropiate signature with a given secret. This is much more compact than the native approach.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>token = jwt.encode(claims=payload, key=secret, headers=headers, algorithm=&quot;HS256&quot;)
print(f&quot;JWT: {token}&quot;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>JWT: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.ezvVIGAaFOrUEWgJSOwDrMyqd-OYTFfv44fADqJt0E0
</pre></div>
</div>
</div>
</div>
</section>
<section id="verifing-token">
<h3>Verifing Token<a class="headerlink" href="#verifing-token" title="Permalink to this headline">#</a></h3>
<p>In this case the method <code class="docutils literal notranslate"><span class="pre">decode</span></code> is used, all the verification logic is handle seemlessly.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from jose.exceptions import JWTError

def verify_jose(token, secret):
    try:
        jwt.decode(token, key=secret, algorithms=[&quot;HS256&quot;])
        return &quot;The token is Valid&quot;
    except JWTError:
        return &quot;The token is NOT valid&quot;
</pre></div>
</div>
</div>
</div>
<section id="trying-to-tamper-the-token">
<h4>Trying to tamper the token<a class="headerlink" href="#trying-to-tamper-the-token" title="Permalink to this headline">#</a></h4>
<p>Since only the implementation changed, the same considerations apply as above regarding changing the headers, the payload or the signature.</p>
</section>
<section id="id2">
<h4>Using Original Token Parts<a class="headerlink" href="#id2" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>verification = verify_jose(token, secret)
print(verification)

decoded_payload = jwt.decode(token, key=secret, algorithms=[&quot;HS256&quot;])

print(f&quot;Decoded Payload: {decoded_payload}&quot;)
print(f&quot;   Payload Type: {type(decoded_payload)}&quot;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The token is Valid
Decoded Payload: {&#39;sub&#39;: &#39;1234567890&#39;, &#39;name&#39;: &#39;John Doe&#39;, &#39;iat&#39;: 1516239022}
   Payload Type: &lt;class &#39;dict&#39;&gt;
</pre></div>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="using-rsa">
<h2>Using RSA<a class="headerlink" href="#using-rsa" title="Permalink to this headline">#</a></h2>
<p>Since Python does not have native support for Asymmetric encryption only library based solutions will be used. One using Cryptography alone and the other using Python JOSE.</p>
<section id="common-data">
<h3>Common Data<a class="headerlink" href="#common-data" title="Permalink to this headline">#</a></h3>
<p>Both Cryptography based and Python JOSE Based will use the same headers, payloads and Key Pair to compare the resulting JWTs.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from cryptography.hazmat.primitives.asymmetric import rsa
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def generate_key_pair():
    key_size = 2048  # Should be at least 2048

    private_key = rsa.generate_private_key(
        public_exponent=65537,  # Do not change
        key_size=key_size,
    )

    public_key = private_key.public_key()
    return private_key, public_key
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>headers = {
  &quot;alg&quot;: &quot;RS256&quot;,  # Changed to use RSA
  &quot;typ&quot;: &quot;JWT&quot;
}

payload = {
  &quot;sub&quot;: &quot;1234567890&quot;,
  &quot;name&quot;: &quot;John Doe&quot;,
  &quot;iat&quot;: 1516239022
}

private_key, public_key = generate_key_pair()
</pre></div>
</div>
</div>
</div>
</section>
<section id="using-cryptography-alone">
<h3>Using Cryptography alone<a class="headerlink" href="#using-cryptography-alone" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from cryptography.hazmat.primitives import serialization, hashes
from cryptography.hazmat.primitives.asymmetric import padding
from cryptography.exceptions import InvalidSignature
</pre></div>
</div>
</div>
</div>
<section id="id3">
<h4>Signature<a class="headerlink" href="#id3" title="Permalink to this headline">#</a></h4>
<section id="encoding-headers-and-payload">
<h5>Encoding Headers and Payload<a class="headerlink" href="#encoding-headers-and-payload" title="Permalink to this headline">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>header_bytes = json.dumps(headers).encode(&quot;utf-8&quot;)
encoded_header = base64.urlsafe_b64encode(header_bytes).decode(&quot;utf-8&quot;)

payload_bytes = json.dumps(payload).encode(&quot;utf-8&quot;)
encoded_payload = base64.urlsafe_b64encode(payload_bytes).decode(&quot;utf-8&quot;)
</pre></div>
</div>
</div>
</div>
</section>
<section id="signing">
<h5>Signing<a class="headerlink" href="#signing" title="Permalink to this headline">#</a></h5>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>message = (encoded_header + &quot;.&quot; +  encoded_payload).encode(&quot;utf-8&quot;)

signature_bytes = private_key.sign(
                      message,
                      padding.PKCS1v15(),
                      hashes.SHA256()
                  )

encoded_signature = base64.urlsafe_b64encode(signature_bytes).decode(&quot;utf-8&quot;)

print(f&quot;Original Signature: {signature_bytes.hex()}&quot;)
print(f&quot; Encoded Signature: {encoded_signature}&quot;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Original Signature: 37237fa50a3e5b37850e2b3c521f59671faa4d8de23d420457c925b54607f09b3cdf2c716edfbe7e05fd196bb1bbe3909d902a420c1487ae05f8d9797b7cb11509fdd3d942854e55b3df24d27fccc129ff9ee4ea5066c66756cda9bbceeb5ad5b6ee114195754990bf50a419c9e35c21a53b27a79c9abd6561e1d409522b8b24240d83d99954dcb2637cd259525b4e4fbc0cbf7e8eeaf53c20262a03ccc94ad05fa7364cefc89dc2b185654b095fa8b302a209792613db303f2abe5478a6ad36ee55f44b6e525a788dfa8331ef45de5532224238b50feeb40f41c72e5ccff1c5997c5b8b23d33f3bf69fe7a8e9b762269f4e77f16544c114426f661c100886bb
 Encoded Signature: NyN_pQo-WzeFDis8Uh9ZZx-qTY3iPUIEV8kltUYH8Js83yxxbt--fgX9GWuxu-OQnZAqQgwUh64F-Nl5e3yxFQn909lChU5Vs98k0n_MwSn_nuTqUGbGZ1bNqbvO61rVtu4RQZV1SZC_UKQZyeNcIaU7J6ecmr1lYeHUCVIriyQkDYPZmVTcsmN80llSW05PvAy_fo7q9TwgJioDzMlK0F-nNkzvyJ3CsYVlSwlfqLMCogl5JhPbMD8qvlR4pq027lX0S25SWniN-oMx70XeVTIiQji1D-60D0HHLlzP8cWZfFuLI9M_O_af56jpt2Imn0538WVEwRRCb2YcEAiGuw==
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="id4">
<h4>Token<a class="headerlink" href="#id4" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>token = f&quot;{encoded_header}.{encoded_payload}.{encoded_signature}&quot; 
print(f&quot;JWT: {token}&quot;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>JWT: eyJhbGciOiAiUlMyNTYiLCAidHlwIjogIkpXVCJ9.eyJzdWIiOiAiMTIzNDU2Nzg5MCIsICJuYW1lIjogIkpvaG4gRG9lIiwgImlhdCI6IDE1MTYyMzkwMjJ9.NyN_pQo-WzeFDis8Uh9ZZx-qTY3iPUIEV8kltUYH8Js83yxxbt--fgX9GWuxu-OQnZAqQgwUh64F-Nl5e3yxFQn909lChU5Vs98k0n_MwSn_nuTqUGbGZ1bNqbvO61rVtu4RQZV1SZC_UKQZyeNcIaU7J6ecmr1lYeHUCVIriyQkDYPZmVTcsmN80llSW05PvAy_fo7q9TwgJioDzMlK0F-nNkzvyJ3CsYVlSwlfqLMCogl5JhPbMD8qvlR4pq027lX0S25SWniN-oMx70XeVTIiQji1D-60D0HHLlzP8cWZfFuLI9M_O_af56jpt2Imn0538WVEwRRCb2YcEAiGuw==
</pre></div>
</div>
</div>
</div>
</section>
<section id="verify-token">
<h4>Verify Token<a class="headerlink" href="#verify-token" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def verify_rsa_cryptography(token, public_key):
    encoded_header, encoded_payload, encoded_signature = token.split(&quot;.&quot;)
    
    padding_correction = &quot;=&quot; * ((4 - len(encoded_signature) % 4) % 4)
    received_signature = base64.urlsafe_b64decode(encoded_signature + padding_correction)
    
    received_message = f&quot;{encoded_header}.{encoded_payload}&quot;.encode(&quot;utf-8&quot;)
    
    try:
        public_key.verify(
            received_signature,
            received_message,
            padding.PKCS1v15(),
            hashes.SHA256()
        )
        return &quot;The token is Valid&quot;
    except InvalidSignature:
        return &quot;The token is NOT Valid&quot;   
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>verify_rsa_cryptography(token, public_key)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;The token is Valid&#39;
</pre></div>
</div>
</div>
</div>
<section id="tampering-scenarios">
<h5>Tampering Scenarios<a class="headerlink" href="#tampering-scenarios" title="Permalink to this headline">#</a></h5>
<p>The same tampering experiments as above could be tested: changing the headers, changing the payload or changing the signature. Since the code would be exactly the same, those cases are not shown for the RSA based JWT.</p>
</section>
</section>
</section>
<section id="using-python-jose">
<h3>Using Python JOSE<a class="headerlink" href="#using-python-jose" title="Permalink to this headline">#</a></h3>
<section id="generating-the-token">
<h4>Generating the Token<a class="headerlink" href="#generating-the-token" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>private_pem_bytes = private_key.private_bytes(
   encoding=serialization.Encoding.PEM,
   format=serialization.PrivateFormat.PKCS8,
   encryption_algorithm=serialization.NoEncryption()
)

token = jwt.encode(claims=payload, key=private_pem_bytes, headers=headers, algorithm=&#39;RS256&#39;)
print(f&quot;JWT: {token}&quot;)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>JWT: eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ.N36K2oSJa74lm-l5NGhB_HQB6EzoiVF0zf2oPDESojApdCkgqYkzLMF444RgYlQ1iNToOhDlV09RX7qYDaft6izHVjCt2YaiCZJRqNil4yQGxBbwocbD6xLal0ZM2Y4cjpip3WaCbDBxZrWJOeIkMWH4cyZZ8cb8o4VFhxcfgzdmSfqyLr1Z_7KTmQrGJmHmR--HkFkHXJuOfoej-wQYSWuShbPyxn6ZjJyG1IglpXtuWE0Wcp9SJP_21rtLpIqZwa7UaP71_JE3N1X3ygbhq8ALouPK_2Dt2YqBuMv5KYkfC4AuAh0itPpRj9VThcHwnKDSyBAYPYR1m1Z_7fpqpQ
</pre></div>
</div>
</div>
</div>
</section>
<section id="verify-the-token">
<h4>Verify the Token<a class="headerlink" href="#verify-the-token" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def verify_rsa_jose(token, public_key_bytes):
    try:
        jwt.decode(token, key=public_key_bytes, algorithms=[&#39;RS256&#39;])
        return &quot;The token is Valid&quot;
    except JWTError:
        return &quot;The token is NOT Valid&quot;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>public_pem_bytes = public_key.public_bytes(
   encoding=serialization.Encoding.PEM,
   format=serialization.PublicFormat.SubjectPublicKeyInfo,
)

verification = verify_rsa_jose(token, public_pem_bytes)
print(verification)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>The token is Valid
</pre></div>
</div>
</div>
</div>
<section id="id5">
<h5>Tampering Scenarios<a class="headerlink" href="#id5" title="Permalink to this headline">#</a></h5>
<p>The same tampering experiments as above could be tested: changing the headers, changing the payload or changing the signature. Since the code would be exactly the same, those cases are not shown for the RSA based JWT.</p>
</section>
</section>
</section>
</section>
<section id="native-vs-library">
<h2>Native vs Library<a class="headerlink" href="#native-vs-library" title="Permalink to this headline">#</a></h2>
<p>It is <strong>NOT</strong> recommended to use any native implementation for anything security related. Instead, always used time proved, well tested libraries.</p>
<p>This is because there might be new vulnerabilities discovered and the library will likely get a patch or an update quick enough, whereas in the case of the native implementation, it is hard to update already-running-in-production solutions.</p>
<p>That being said and just for completeness, a time benchmark is shown below.</p>
<section id="cross-compatibility">
<h3>Cross Compatibility<a class="headerlink" href="#cross-compatibility" title="Permalink to this headline">#</a></h3>
</section>
<section id="using-hmac">
<h3>Using HMAC<a class="headerlink" href="#using-hmac" title="Permalink to this headline">#</a></h3>
<p>It is possible to encode with the native implementation and decode with the library and the other way around, that is because the JWT is a standard.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def create_token_native(headers, payload, secret):
    header_bytes = json.dumps(headers).encode(&quot;utf-8&quot;)
    encoded_header = base64.urlsafe_b64encode(header_bytes).decode(&quot;utf-8&quot;)
    
    payload_bytes = json.dumps(payload).encode(&quot;utf-8&quot;)
    encoded_payload = base64.urlsafe_b64encode(payload_bytes).decode(&quot;utf-8&quot;)
    
    message = (encoded_header + &quot;.&quot; +  encoded_payload).encode(&quot;utf-8&quot;)
    signature_bytes = hmac.digest(secret, message, digest=hashlib.sha256)

    encoded_signature = base64.urlsafe_b64encode(signature_bytes).decode(&quot;utf-8&quot;)
    
    return f&quot;{encoded_header}.{encoded_payload}.{encoded_signature}&quot;


def create_token_jose(headers, payload, secret):
    return jwt.encode(claims=payload, key=secret, headers=headers, algorithm=&quot;HS256&quot;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>headers = {
  &quot;alg&quot;: &quot;HS256&quot;,
  &quot;typ&quot;: &quot;JWT&quot;
}

payload = {
  &quot;sub&quot;: &quot;1234567890&quot;,
  &quot;name&quot;: &quot;John Doe&quot;,
  &quot;iat&quot;: 1516239022
}

secret = secrets.token_bytes(16)
</pre></div>
</div>
</div>
</div>
<section id="encode-with-native-decode-with-library">
<h4>Encode with Native decode with Library<a class="headerlink" href="#encode-with-native-decode-with-library" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>token = create_token_native(headers, payload, secret)
verify_jose(token, secret)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;The token is Valid&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="encode-with-library-decode-with-native">
<h4>Encode with Library decode with Native<a class="headerlink" href="#encode-with-library-decode-with-native" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>token = create_token_jose(headers, payload, secret)
verify(token, secret)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;The token is Valid&#39;
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="id6">
<h3>Using RSA<a class="headerlink" href="#id6" title="Permalink to this headline">#</a></h3>
<p>When dealing with RSA, there is also cross compatibility between Cryptography and Python JOSE. This is non-trivial since Python JOSE does not use Cryptography as backend for RSA.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>def create_token_rsa_cryptography(headers, payload, private_key):
    header_bytes = json.dumps(headers).encode(&quot;utf-8&quot;)
    encoded_header = base64.urlsafe_b64encode(header_bytes).decode(&quot;utf-8&quot;)

    payload_bytes = json.dumps(payload).encode(&quot;utf-8&quot;)
    encoded_payload = base64.urlsafe_b64encode(payload_bytes).decode(&quot;utf-8&quot;)

    message = (encoded_header + &quot;.&quot; +  encoded_payload).encode(&quot;utf-8&quot;)

    signature_bytes = private_key.sign(message, padding.PKCS1v15(), hashes.SHA256())

    encoded_signature = base64.urlsafe_b64encode(signature_bytes).decode(&quot;utf-8&quot;)

    return f&quot;{encoded_header}.{encoded_payload}.{encoded_signature}&quot; 


def create_token_rsa_jose(headers, payload, private_pem_bytes):
    return jwt.encode(claims=payload, key=private_pem_bytes, headers=headers, algorithm=&#39;RS256&#39;)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>headers = {
  &quot;alg&quot;: &quot;RS256&quot;,
  &quot;typ&quot;: &quot;JWT&quot;
}

payload = {
  &quot;sub&quot;: &quot;1234567890&quot;,
  &quot;name&quot;: &quot;John Doe&quot;,
  &quot;iat&quot;: 1516239022
}

private_key, public_key = generate_key_pair()

private_pem_bytes = private_key.private_bytes(
   encoding=serialization.Encoding.PEM,
   format=serialization.PrivateFormat.PKCS8,
   encryption_algorithm=serialization.NoEncryption()
)

public_pem_bytes = public_key.public_bytes(
   encoding=serialization.Encoding.PEM,
   format=serialization.PublicFormat.SubjectPublicKeyInfo,
)
</pre></div>
</div>
</div>
</div>
<section id="encode-with-cryptography-decode-with-python-jose">
<h4>Encode with Cryptography decode with Python JOSE<a class="headerlink" href="#encode-with-cryptography-decode-with-python-jose" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>token = create_token_rsa_cryptography(headers, payload, private_key)
verify_rsa_jose(token, public_pem_bytes)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;The token is Valid&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="encode-with-python-jose-decode-with-cryptography">
<h4>Encode with Python JOSE decode with Cryptography<a class="headerlink" href="#encode-with-python-jose-decode-with-cryptography" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>token = create_token_rsa_jose(headers, payload, private_pem_bytes)
verify_rsa_cryptography(token, public_key)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;The token is Valid&#39;
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="hmac-time-benchmark">
<h3>HMAC Time Benchmark<a class="headerlink" href="#hmac-time-benchmark" title="Permalink to this headline">#</a></h3>
<section id="id7">
<h4>Generating the token<a class="headerlink" href="#id7" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>print(&quot;Native:&quot;, end=&quot; &quot;)
%timeit create_token_native(headers, payload, secret)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Native: 37.9 µs ± 2.88 µs per loop (mean ± std. dev. of 7 runs, 10000 loops each)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>print(&quot;  Jose:&quot;, end=&quot; &quot;)
%timeit create_token_jose(headers, payload, secret)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  Jose: 104 µs ± 5.15 µs per loop (mean ± std. dev. of 7 runs, 10000 loops each)
</pre></div>
</div>
</div>
</div>
</section>
<section id="verifying-the-token">
<h4>Verifying the token<a class="headerlink" href="#verifying-the-token" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>token = create_token_jose(headers, payload, secret)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>print(&quot;Native:&quot;, end=&quot; &quot;)
%timeit verify(token, secret)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Native: 18 µs ± 1.14 µs per loop (mean ± std. dev. of 7 runs, 100000 loops each)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>print(&quot;  Jose:&quot;, end=&quot; &quot;)
%timeit verify_jose(token, secret)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>  Jose: 32.1 µs ± 4.61 µs per loop (mean ± std. dev. of 7 runs, 10000 loops each)
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="rsa-time-benchmark">
<h3>RSA Time Benchmark<a class="headerlink" href="#rsa-time-benchmark" title="Permalink to this headline">#</a></h3>
<section id="id8">
<h4>Generating the token<a class="headerlink" href="#id8" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>print(&quot;Cryptography:&quot;, end=&quot; &quot;)
%timeit create_token_rsa_cryptography(headers, payload, private_key)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cryptography: 2.3 ms ± 268 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>print(&quot; Python Jose:&quot;, end=&quot; &quot;)
%timeit create_token_rsa_jose(headers, payload, private_pem_bytes)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> Python Jose: 14.3 ms ± 549 µs per loop (mean ± std. dev. of 7 runs, 100 loops each)
</pre></div>
</div>
</div>
</div>
</section>
<section id="id9">
<h4>Verifying the token<a class="headerlink" href="#id9" title="Permalink to this headline">#</a></h4>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>token = create_token_rsa_jose(headers, payload, private_pem_bytes)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>print(&quot;Cryptography:&quot;, end=&quot; &quot;)
%timeit verify_rsa_cryptography(token, public_key)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Cryptography: 158 µs ± 6.23 µs per loop (mean ± std. dev. of 7 runs, 10000 loops each)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>print(&quot; Python Jose:&quot;, end=&quot; &quot;)
%timeit verify_rsa_jose(token, public_pem_bytes)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span> Python Jose: 418 µs ± 39.5 µs per loop (mean ± std. dev. of 7 runs, 1000 loops each)
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="caveats-other-jwt-features">
<h3>Caveats: Other JWT Features<a class="headerlink" href="#caveats-other-jwt-features" title="Permalink to this headline">#</a></h3>
<p>One important remark of JWT is that the validity of the signature is not the only check that should be passed to make the JWT valid. As an example it is possible to define an experitation date or a not-valid-before date. Those checks are automatically checked by Python JOSE but are missing in the Native and the Cryptography implementations since the only part implemented was the signature verification.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>from datetime import datetime, timedelta
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>headers = {
  &quot;alg&quot;: &quot;HS256&quot;,
  &quot;typ&quot;: &quot;JWT&quot;
}

secret = secrets.token_bytes(16)

this_moment = datetime.now()
issue_date = (this_moment - timedelta(hours=24)).timestamp()
</pre></div>
</div>
</div>
</div>
<section id="not-valid-before-date">
<h4>Not Valid Before Date<a class="headerlink" href="#not-valid-before-date" title="Permalink to this headline">#</a></h4>
<p>If the <code class="docutils literal notranslate"><span class="pre">nbf</span></code> field is set to some time in the future (e.g. in 2hs) the token will not be valid until then.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>start_since = (this_moment + timedelta(hours=2)).timestamp()

payload = {
  &quot;name&quot;: &quot;John Doe&quot;,
  &quot;iat&quot;: issue_date,
  &quot;nbf&quot;: start_since
}

token = create_token_native(headers, payload, secret)
</pre></div>
</div>
</div>
</div>
<p>Since the <code class="docutils literal notranslate"><span class="pre">verify</span></code> function only checks the signature, the token will be valid</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>verify(token, secret)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;The token is Valid&#39;
</pre></div>
</div>
</div>
</div>
<p>However, Python JOSE has this as a native feature already and thus it will identify the JWT as invalid.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>verify_jose(token, secret)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;The token is NOT valid&#39;
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="expiration-date">
<h3>Expiration Date<a class="headerlink" href="#expiration-date" title="Permalink to this headline">#</a></h3>
<p>If instead a hard expiration date for the token is provided by the <code class="docutils literal notranslate"><span class="pre">exp</span></code> claim, the token will not be valid after that. It is always recommended to have this field, users can always re-generate JWTs if needed.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>expiration = (this_moment - timedelta(hours=2)).timestamp()

payload = {
  &quot;name&quot;: &quot;John Doe&quot;,
  &quot;iat&quot;: issue_date,
  &quot;exp&quot;: expiration
}

token = create_token_native(headers, payload, secret)
</pre></div>
</div>
</div>
</div>
<p>Since the <code class="docutils literal notranslate"><span class="pre">verify</span></code> function only checks the signature, the token will be valid</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>verify(token, secret)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;The token is Valid&#39;
</pre></div>
</div>
</div>
</div>
<p>However, Python JOSE has this as a native feature already and thus it will identify the JWT as invalid.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>verify_jose(token, secret)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;The token is NOT valid&#39;
</pre></div>
</div>
</div>
</div>
</section>
<section id="comparison-conclusion">
<h3>Comparison Conclusion<a class="headerlink" href="#comparison-conclusion" title="Permalink to this headline">#</a></h3>
<p>Regardless of the particular implementation, RSA based JWT was much slower than HMAC based. This corresponds to symmetric encryption being much faster than asymmetric.</p>
<p>Even though the Native implementation was faster than the Python JOSE one, it is <strong>NOT</strong> recommended to use any custom solution for security related problems. The sames applies to the comparison between Cryptography and Python JOSE. This can be seen by Python JOSE implementing other checks that were not present in the Native and Cryptography implementations.</p>
<p>Python JOSE is a library specifically developed for JWT manipulation and therefore should be the go to approach. However, other JWT libraries could also be used if they are time proved and well tested.</p>
</section>
</section>
<section id="example-user-authentication">
<h2>Example: User Authentication<a class="headerlink" href="#example-user-authentication" title="Permalink to this headline">#</a></h2>
<p>The following example showcases how JWTs can be used to securely login users. <strong>This example is based on the <a class="reference internal" href="02_Salt.html"><span class="doc std std-doc">Salt Chapter’s</span></a></strong>.</p>
<p>The scenario is having two tables: <code class="docutils literal notranslate"><span class="pre">users</span></code> and <code class="docutils literal notranslate"><span class="pre">roles</span></code>. Each user will have its password hashed with salt and then on other unencrypted table, each user will have a role. There is a site to which only users with the <code class="docutils literal notranslate"><span class="pre">admin</span></code> role can access. In this example the authorization to that site is handled by JWTs. The main advantage is that once the JWT was generated, all relevant (non-secret) information of the user is saved there, meaning that JWT is specially useful for stateless APIs).</p>
<p>This example uses HMAC but the same could be achieved using RSA.</p>
<p><strong>Note: Remember that this code is not suitable for any production use-case.</strong></p>
<section id="auxiliary-functions">
<h3>Auxiliary Functions<a class="headerlink" href="#auxiliary-functions" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import os
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>os.environ[&quot;SECRET_JWT&quot;] = secrets.token_hex(32)

def generate_hash(data:str, salt: bytes) -&gt; str:
    data_bytes = data.encode(&quot;utf-8&quot;)
    data_hashed = hashlib.scrypt(data_bytes, salt=salt, n=64, r=8, p=1)
    return f&quot;{salt.hex()}:{data_hashed.hex()}&quot;


def sign_up(email, password, database_):
    database = database_.copy()
    random_bytes = secrets.token_bytes(10)
    database[email] = generate_hash(password, random_bytes)
    print(f&quot;Successfully Singed Up: {email}&quot;)
    return database


def login(email, password, database, roles):
    if email not in database:
        print(f&quot;ERROR: User {email} not in Database&quot;)
        return

    expected_password = database[email]
    salt, hashed = expected_password.split(&quot;:&quot;)
    salt_bytes = bytes.fromhex(salt)
    calculated_hash = generate_hash(password, salt_bytes)
    passwords_matched = secrets.compare_digest(expected_password, calculated_hash) 
    
    if not passwords_matched:
        print(f&quot;ERROR: Incorrect Password for: {email}&quot;)
        return
        
    headers = {
      &quot;alg&quot;: &quot;HS256&quot;,
      &quot;typ&quot;: &quot;JWT&quot;
    }
    
    this_moment = datetime.now()

    payload = {
      &quot;email&quot;: email,
      &quot;role&quot;: roles[email],
      &quot;iat&quot;: this_moment.timestamp(),
      &quot;exp&quot;: (this_moment + timedelta(seconds=10)).timestamp()
    }

    secret = os.environ.get(&quot;SECRET_JWT&quot;)

    print(f&quot;Successfully Logged in: {email}&quot;)
    return jwt.encode(claims=payload, key=secret, headers=headers, algorithm=&quot;HS256&quot;)
    
    
def access_restricted_site(token):
    secret = os.environ.get(&quot;SECRET_JWT&quot;)
    try:
        payload = jwt.decode(token, secret, algorithms=[&quot;HS256&quot;])
        role = payload[&quot;role&quot;]
        if role == &quot;admin&quot;:
            return &quot;Access Granted&quot;
        return &quot;You are logged in but you do not have access to this site&quot;
    except JWTError:
        return &quot;Your token is invalid, log in first&quot;
</pre></div>
</div>
</div>
</div>
</section>
<section id="sign-up">
<h3>Sign Up<a class="headerlink" href="#sign-up" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>roles = {
    &quot;johndoe@example.com&quot;: &quot;user&quot;,
    &quot;alicedoe@example.com&quot;: &quot;admin&quot;,
}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>email = &quot;johndoe@example.com&quot;
password = &quot;password123&quot;
user_database = {}

user_database = sign_up(email, password, user_database)

email = &quot;alicedoe@example.com&quot;
password = &quot;adminadmin&quot;
user_database = sign_up(email, password, user_database)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Successfully Singed Up: johndoe@example.com
Successfully Singed Up: alicedoe@example.com
</pre></div>
</div>
</div>
</div>
</section>
<section id="log-in">
<h3>Log In<a class="headerlink" href="#log-in" title="Permalink to this headline">#</a></h3>
<section id="not-enough-priviliges">
<h4>Not Enough Priviliges<a class="headerlink" href="#not-enough-priviliges" title="Permalink to this headline">#</a></h4>
<p>John logs in and tries to access the restricted site.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>email = &quot;johndoe@example.com&quot;
password = &quot;password123&quot;

john_jwt_token = login(email, password, user_database, roles)

authentication_message = access_restricted_site(john_jwt_token)

print(authentication_message)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Successfully Logged in: johndoe@example.com
You are logged in but you do not have access to this site
</pre></div>
</div>
</div>
</div>
</section>
<section id="tampering-priviliges">
<h4>Tampering Priviliges<a class="headerlink" href="#tampering-priviliges" title="Permalink to this headline">#</a></h4>
<p>John can decode his token and see that the <code class="docutils literal notranslate"><span class="pre">role</span></code> he was assigned is <code class="docutils literal notranslate"><span class="pre">user</span></code> and not admin, he could try to change that and generate a new token. However as shown above, changing only the payload will invalidate the token and since John does not have the secret, it cannot update the <code class="docutils literal notranslate"><span class="pre">signature</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>original_header, original_payload, original_signature = john_jwt_token.split(&quot;.&quot;)

padding_correction = &quot;=&quot; * ((4 - len(original_payload) % 4) % 4)

decoded_payload = base64.urlsafe_b64decode(original_payload + padding_correction)
decoded_payload_dict = json.loads(decoded_payload)
decoded_payload_dict[&quot;role&quot;] = &quot;admin&quot;
tampered_payload = json.dumps(decoded_payload_dict).encode(&quot;utf-8&quot;)
tampered_payload_encoded = base64.urlsafe_b64encode(tampered_payload)

tampered_token = f&quot;{original_header}.{tampered_payload_encoded}.{original_signature}&quot;

authentication_message = access_restricted_site(tampered_token)

print(authentication_message)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Your token is invalid, log in first
</pre></div>
</div>
</div>
</div>
</section>
<section id="having-enough-priviliges">
<h4>Having Enough Priviliges<a class="headerlink" href="#having-enough-priviliges" title="Permalink to this headline">#</a></h4>
<p>For Alice the process is seemless and she can access without any problems</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>email = &quot;alicedoe@example.com&quot;
password = &quot;adminadmin&quot;

alice_jwt_token = login(email, password, user_database, roles)

authentication_message = access_restricted_site(alice_jwt_token)

print(authentication_message)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Successfully Logged in: alicedoe@example.com
Access Granted
</pre></div>
</div>
</div>
</div>
</section>
<section id="token-expired">
<h4>Token Expired<a class="headerlink" href="#token-expired" title="Permalink to this headline">#</a></h4>
<p>The token was configured to expire in 10s, this is an artificially small amount of time just for demonstration purposes. Alice was able to access the restricted site but now, 10 seconds after, the token is not valid any more.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>import time

time.sleep(10)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>authentication_message = access_restricted_site(alice_jwt_token)

print(authentication_message)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Your token is invalid, log in first
</pre></div>
</div>
</div>
</div>
</section>
<section id="caveats">
<h4>Caveats<a class="headerlink" href="#caveats" title="Permalink to this headline">#</a></h4>
<p>If John get Alice’s JWT by any means, he could have access to the restricted site. This risk can be mitigated by using certificate based authentication or strong security measures of the JWT.</p>
<p>The JWT is ultimately an access card, anyone who has it, can acts as if it were the user to whom it was originally given. That is why other measure such as certificates can be add to avoid misuse of JWTs.</p>
</section>
</section>
</section>
<section id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">#</a></h2>
<p>JSON Web Tokens (JWT) combines several cryptography concepts in a practical way, it allows to generate tokens, that are easy to share via HTTP and that serves for authentication of users. They also allow for custom fields, giving extra flexibility.</p>
<p>JWTs are compatible with both symmetric and asymmetric digital signatures by using HMAC and RSA respectively. When one the party generating the token should verify it, HMAC is the most convenient solution, if everone should be able to verify the signature RSA is most convenient. There are many other algorithms supported by the JWT standard but those two are the most popular ones.</p>
<p>In this chapter a Native and a Library based implementation were shown, the native one should not be used by any means and it is only for illustration purposes.</p>
<p>Using JWTs is becoming more and more common nowadays with the rise of Stateless API architectures and microservices. And is widely use in the <a class="reference external" href="https://en.wikipedia.org/wiki/OAuth">Open Authorization (OAuth)</a></p>
</section>
<section id="additional-resources">
<h2>Additional Resources<a class="headerlink" href="#additional-resources" title="Permalink to this headline">#</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://jwt.io/">JWT.io</a>: a free online service that lets you decode, verify and generate JWT</p></li>
<li><p>Other JWT Libraries for Python: <a class="reference external" href="https://github.com/jpadilla/pyjwt/">pyjwt</a>, <a class="reference external" href="https://github.com/latchset/jwcrypto/">jwcrypto</a> and <a class="reference external" href="https://github.com/lepture/authlib">authlib</a></p></li>
</ul>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "ELC/python-security",
            ref: "source",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./chapters"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="09_Common_Threats.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Common Threats - Under Construction</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="19_Blockchain.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">BlockChain - Under Construction</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Ezequiel Leonardo Castaño<br/>
  
      &copy; Copyright 2021, Ezequiel Leonardo Castaño.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>